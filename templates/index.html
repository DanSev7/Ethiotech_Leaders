{% extends "base.html" %}
{% load icon_filters %}
{% load static %}

{% block title %}{{ site_settings.site_name|default:"EthioSites" }}{% endblock %}

{% block content %}

{% include 'sections/hero.html' %}

{% for section in sections %}
<section id="section-{{ forloop.counter }}" class="w-full py-20" style="background-color: {{ section.section_bg_color|default:'#f9fafb' }}; color: {{ section.section_text_color|default:'#1f2937' }};">
    <div class="container mx-auto px-4">
        
        {% if section.section_type == "hero" %}
        {% include 'sections/hero.html' %}
        
        {% elif section.section_type == "stats" %}
        {% include 'sections/stats.html' %}
        
        {% elif section.section_type == "features" %}
        {% include 'sections/features.html' %}
        
        {% elif section.section_type == "testimonials" %}
        {% include 'sections/testimonials.html' %}
        
        {% elif section.section_type == "cta" %}
        {% include 'sections/cta.html' %}
        
        {% elif section.section_type == "impact" %}
        {% include 'sections/impact.html' %}
        
        {% elif section.section_type == "team" %}
        {% include 'sections/team.html' %}
        
        {% elif section.section_type == "pricing" %}
        {% include 'sections/pricing.html' %}
        
        {% elif section.section_type == "faq" %}
        {% include 'sections/faq.html' %}
        
        {% elif section.section_type == "contact" %}
        {% include 'sections/contact.html' %}
        
        {% else %}
        <!-- Default grid layout -->
        {% if section.name %}
        <h2 class="text-3xl md:text-4xl font-extrabold mb-4 text-center">
            {{ section.name }}
        </h2>
        {% endif %}
        
        {% if section.description %}
        <div class="text-lg mb-10 ck-content text-center max-w-3xl mx-auto">{{ section.description|safe }}</div>
        {% endif %}
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-{{ section.columns|default:3 }} gap-10" style="gap: {{ section.card_gap|default:'2.5rem' }};">
            {% for card in section.card_block.all %}
            {% if card.is_active %}
            {% include 'partials/cards/default_card.html' with card=card section=section %}
            {% endif %}
            {% endfor %}
        </div>
        
        {% if section.cta_label and section.cta_url %}
        <div class="mt-12 text-center">
            <a href="{{ section.cta_url }}" 
               target="{{ section.cta_target|default:'_self' }}"
               class="inline-block px-8 py-4 rounded-full font-bold text-lg transition-all transform hover:scale-105 shadow-xl"
               style="background-color: {{ section.cta_bg_color|default:'#3b82f6' }}; color: {{ section.cta_text_color|default:'white' }};"
               onclick="trackSectionCTAClick({{ section.id }}, event)">
                {{ section.cta_label }}
            </a>
        </div>
        {% endif %}
        {% endif %}
    </div>
</section>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
    // Track Section CTA Click
    function trackSectionCTAClick(sectionId, event) {
        event.preventDefault();
        const link = event.target.closest('a');
        const url = link ? link.href : '#';
        
        // Send AJAX request to track the click
        fetch(`/track/section-cta-click/${sectionId}/`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        }).then(response => {
            if (response.ok) {
                // Redirect to the original URL after tracking
                if (url !== '#') {
                    window.location.href = url;
                }
            }
        }).catch(error => {
            console.error('Error tracking click:', error);
            // Redirect anyway if tracking fails
            if (url !== '#') {
                window.location.href = url;
            }
        });
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}