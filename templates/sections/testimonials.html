{% load icon_filters %}
<div class="testimonials-section py-16">
  <div class="container mx-auto px-4">
    <div class="text-center mb-16">
      {% if section.name %}
      <h2 class="text-3xl md:text-4xl font-bold mb-4" style="color: {{ section.section_text_color|default:'#1f2937' }};">
        {{ section.name }}
      </h2>
      {% endif %}
      
      {% if section.description %}
      <div class="text-lg max-w-3xl mx-auto ck-content" style="color: {{ section.section_text_color|default:'#4b5563' }};">
        {{ section.description|safe }}
      </div>
      {% endif %}
    </div>
    
    <!-- Slidable Testimonials Carousel -->
    <div class="relative">
      <div class="overflow-hidden">
        <div class="flex transition-transform duration-500 ease-in-out" id="testimonialsCarousel">
          {% for card in section.card_block.all %}
          {% if card.is_active %}
          <div class="flex-shrink-0 w-full md:w-1/2 lg:w-1/3 px-4">
            <div class="p-8 rounded-xl shadow-lg h-full" 
                 style="background-color: {{ card.card_bg_color|default:'#ffffff' }}; color: {{ card.card_text_color|default:'#1f2937' }};">
              
              {% if card.icon %}
              <div class="mb-4">
                <i data-lucide="{{ card.icon|to_kebab_case }}"
                   style="width:{{ card.icon_size|default:24 }}px;height:{{ card.icon_size|default:24 }}px;color:{{ card.icon_color|default:'#3b82f6' }};">
                </i>
              </div>
              {% endif %}
              
              {% if card.text %}
              <div class="ck-content mb-6 italic" style="color: {{ card.card_text_color|default:'#4b5563' }};">
                {{ card.text|safe }}
              </div>
              {% endif %}
              
              <div class="flex items-center">
                {% if card.image %}
                <img src="{{ card.image.url }}" alt="{{ card.image_alt|default:card.title }}" class="w-12 h-12 rounded-full mr-4">
                {% endif %}
                <div>
                  <div class="font-semibold" style="color: {{ card.card_text_color|default:'#1f2937' }};">
                    {{ card.title }}
                  </div>
                  {% if card.button_label %}
                  <div class="text-sm" style="color: {{ card.card_text_color|default:'#6b7280' }};">
                    {{ card.button_label }}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          {% endfor %}
        </div>
      </div>
      
      <!-- Navigation Arrows -->
      <button id="prevTestimonial" class="absolute left-0 top-1/2 transform -translate-y-1/2 -translate-x-6 bg-white rounded-full p-3 shadow-lg hover:bg-gray-100 transition">
        <i data-lucide="chevron-left" class="w-6 h-6 text-gray-700"></i>
      </button>
      <button id="nextTestimonial" class="absolute right-0 top-1/2 transform -translate-y-1/2 translate-x-6 bg-white rounded-full p-3 shadow-lg hover:bg-gray-100 transition">
        <i data-lucide="chevron-right" class="w-6 h-6 text-gray-700"></i>
      </button>
      
      <!-- Dots Indicator -->
      <div class="flex justify-center mt-8 space-x-2" id="testimonialDots">
        <!-- Dots will be generated by JavaScript -->
      </div>
    </div>
    
    {% if section.cta_label and section.cta_url %}
    <div class="mt-12 text-center">
        <a href="{{ section.cta_url }}" 
           target="{{ section.cta_target|default:'_self' }}"
           class="inline-block px-8 py-4 rounded-full font-bold text-lg transition-all transform hover:scale-105 shadow-xl"
           style="background-color: {{ section.cta_bg_color|default:'#3b82f6' }}; color: {{ section.cta_text_color|default:'white' }};">
            {{ section.cta_label }}
        </a>
    </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const carousel = document.getElementById('testimonialsCarousel');
  const prevBtn = document.getElementById('prevTestimonial');
  const nextBtn = document.getElementById('nextTestimonial');
  const dotsContainer = document.getElementById('testimonialDots');
  
  if (carousel && prevBtn && nextBtn) {
    const cards = carousel.children;
    const cardCount = cards.length;
    const cardWidth = cards[0].offsetWidth;
    let currentIndex = 0;
    
    // Create dots
    if (dotsContainer) {
      for (let i = 0; i < cardCount; i++) {
        const dot = document.createElement('button');
        dot.className = 'w-3 h-3 rounded-full bg-gray-300 hover:bg-gray-400 transition';
        dot.dataset.index = i;
        if (i === 0) dot.classList.add('bg-blue-500');
        dot.addEventListener('click', () => goToSlide(i));
        dotsContainer.appendChild(dot);
      }
    }
    
    function updateCarousel() {
      carousel.style.transform = `translateX(-${currentIndex * cardWidth}px)`;
      
      // Update dots
      if (dotsContainer) {
        const dots = dotsContainer.children;
        for (let i = 0; i < dots.length; i++) {
          dots[i].classList.toggle('bg-blue-500', i === currentIndex);
          dots[i].classList.toggle('bg-gray-300', i !== currentIndex);
        }
      }
    }
    
    function goToSlide(index) {
      currentIndex = index;
      updateCarousel();
    }
    
    function nextSlide() {
      currentIndex = (currentIndex + 1) % cardCount;
      updateCarousel();
    }
    
    function prevSlide() {
      currentIndex = (currentIndex - 1 + cardCount) % cardCount;
      updateCarousel();
    }
    
    prevBtn.addEventListener('click', prevSlide);
    nextBtn.addEventListener('click', nextSlide);
    
    // Auto slide every 5 seconds
    setInterval(nextSlide, 5000);
  }
});
</script>