{% load static %}
{% load custom_filters %}
{% load icon_filters %}

<!-- Hero Section -->
{% if hero %}
<section class="hero-section relative overflow-hidden flex items-center" style="background-color: {{ hero.bg_color|default:'#1f2937' }}; min-height: 75vh;">
    
    {% if hero.layout_type == 'text-center-image-background' %}
        <div class="hero-background-slider absolute inset-0 z-0">
            {% for bg_image in hero.background_images.all %}
            <div class="hero-bg-image absolute inset-0 opacity-0 transition-opacity duration-1000" 
                 data-index="{{ forloop.counter0 }}"
                 style="background-image: url('{{ bg_image.image.url }}'); background-size: cover; background-position: center;">
            </div>
            {% endfor %}
            <div class="absolute inset-0 bg-black opacity-50"></div>
        </div>

        <div class="relative z-10 container mx-auto px-4 py-20 text-center w-full">
            <h1 class="text-4xl md:text-6xl lg:text-7xl font-extrabold mb-6 text-white tracking-tight drop-shadow-2xl">
                {{ hero.title }}
            </h1>
            
            {% if hero.rotating_texts.all %}
            <div class="mb-6">
                <span class="rotating-text inline-block text-4xl md:text-5xl font-bold transition-all duration-300" style="color: {{ hero.cta_bg_color|default:'#3b82f6' }};"></span>
            </div>
            {% endif %}
            
            {% if hero.subtitle_description %}
            <div class="text-xl md:text-2xl text-gray-200 mb-10 ck-content drop-shadow-md max-w-4xl mx-auto">
                {{ hero.subtitle_description|safe }}
            </div>
            {% endif %}
            
            {% if hero.cta_text or hero.cta_link %}
            <div class="mt-8">
                <a href="{{ hero.cta_link|default:'#' }}" 
                   class="inline-block px-12 py-4 rounded-2xl font-bold text-xl transition-all transform hover:scale-105 shadow-xl "
                   style="background-color: {{ hero.cta_bg_color|default:'#3b82f6' }}; color: white; "
                   {% if not hero.cta_link %}onclick="return false;"{% endif %}
                   onclick="trackHeroCTAClick(event)">
                    {{ hero.cta_text|default:'Learn More' }}
                </a>
            </div>
            {% endif %}
        </div>
    
    {% elif hero.layout_type == 'text-center-no-image' %}
        <div class="container mx-auto px-4 py-24 text-center w-full">
            <h1 class="text-4xl md:text-6xl font-extrabold mb-6" style="color: {{ hero.title_color|default:'#1f2937' }};">
                {{ hero.title }}
            </h1>
            {% if hero.rotating_texts.all %}
            <div class="mb-6">
                <span class="rotating-text inline-block text-4xl md:text-5xl font-bold transition-all duration-300" style="color: {{ hero.cta_bg_color|default:'#3b82f6' }};"></span>
            </div>
            {% endif %}
            {% if hero.subtitle_description %}
            <div class="text-xl md:text-2xl mb-8 ck-content max-w-3xl mx-auto" style="color: {{ hero.subtitle_color|default:'#4b5563' }};">
                {{ hero.subtitle_description|safe }}
            </div>
            {% endif %}
            {% if hero.cta_text or hero.cta_link %}
            <div class="mt-8">
                <a href="{{ hero.cta_link|default:'#' }}" 
                   class="inline-block px-10 py-4 rounded-full font-bold text-lg transition-all transform hover:scale-105 shadow-xl ring-2 ring-offset-2 ring-offset-current"
                   style="background-color: {{ hero.cta_bg_color|default:'#3b82f6' }}; color: white; ring-color: {{ hero.cta_bg_color|default:'#3b82f6' }};"
                   {% if not hero.cta_link %}onclick="return false;"{% endif %}>
                    {{ hero.cta_text|default:'Learn More' }}
                </a>
            </div>
            {% endif %}
        </div>
    
    {% elif hero.layout_type == 'text-left-image-right' %}
        <div class="container mx-auto px-4 py-20 w-full">
            <div class="grid md:grid-cols-2 gap-16 items-center">
                <div>
                    <h1 class="text-4xl md:text-5xl font-extrabold mb-6" style="color: {{ hero.title_color|default:'#1f2937' }};">
                        {{ hero.title }}
                    </h1>
                    {% if hero.rotating_texts.all %}
                    <div class="mb-6">
                        <span class="rotating-text inline-block text-3xl md:text-4xl font-bold transition-all duration-300" style="color: {{ hero.cta_bg_color|default:'#3b82f6' }};"></span>
                    </div>
                    {% endif %}
                    {% if hero.subtitle_description %}
                    <div class="text-lg md:text-xl mb-8 ck-content" style="color: {{ hero.subtitle_color|default:'#4b5563' }};">
                        {{ hero.subtitle_description|safe }}
                    </div>
                    {% endif %}
                    {% if hero.cta_text or hero.cta_link %}
                    <div class="mt-8">
                        <a href="{{ hero.cta_link|default:'#' }}" 
                           class="inline-block px-10 py-4 rounded-full font-bold text-lg transition-all transform hover:scale-105 shadow-xl ring-2 ring-offset-2 ring-offset-current"
                           style="background-color: {{ hero.cta_bg_color|default:'#3b82f6' }}; color: white; ring-color: {{ hero.cta_bg_color|default:'#3b82f6' }};"
                           {% if not hero.cta_link %}onclick="return false;"{% endif %}
                           onclick="trackHeroCTAClick(event)">
                            {{ hero.cta_text|default:'Learn More' }}
                        </a>
                    </div>
                    {% endif %}
                </div>
                <div class="relative">
                    {% if hero.background_images.all %}
                    <div class="hero-image-slider relative h-96 rounded-2xl shadow-2xl overflow-hidden">
                        {% for bg_image in hero.background_images.all %}
                        <img src="{{ bg_image.image.url }}" 
                             alt="Hero image {{ forloop.counter }}"
                             class="hero-slide-image absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-1000"
                             data-index="{{ forloop.counter0 }}">
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    
    {% elif hero.layout_type == 'text-right-image-left' %}
        <div class="container mx-auto px-4 py-20 w-full">
            <div class="grid md:grid-cols-2 gap-16 items-center">
                <div class="relative order-2 md:order-1">
                    {% if hero.background_images.all %}
                    <div class="hero-image-slider relative h-96 rounded-2xl shadow-2xl overflow-hidden">
                        {% for bg_image in hero.background_images.all %}
                        <img src="{{ bg_image.image.url }}" 
                             alt="Hero image {{ forloop.counter }}"
                             class="hero-slide-image absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-1000"
                             data-index="{{ forloop.counter0 }}">
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="order-1 md:order-2">
                    <h1 class="text-4xl md:text-5xl font-extrabold mb-6" style="color: {{ hero.title_color|default:'#1f2937' }};">
                        {{ hero.title }}
                    </h1>
                    {% if hero.rotating_texts.all %}
                    <div class="mb-6">
                        <span class="rotating-text inline-block text-3xl md:text-4xl font-bold transition-all duration-300" style="color: {{ hero.cta_bg_color|default:'#3b82f6' }};"></span>
                    </div>
                    {% endif %}
                    {% if hero.subtitle_description %}
                    <div class="text-lg md:text-xl mb-8 ck-content" style="color: {{ hero.subtitle_color|default:'#4b5563' }};">
                        {{ hero.subtitle_description|safe }}
                    </div>
                    {% endif %}
                    {% if hero.cta_text or hero.cta_link %}
                    <div class="mt-8">
                        <a href="{{ hero.cta_link|default:'#' }}" 
                           class="inline-block px-10 py-4 rounded-full font-bold text-lg transition-all transform hover:scale-105 shadow-xl ring-2 ring-offset-2 ring-offset-current"
                           style="background-color: {{ hero.cta_bg_color|default:'#3b82f6' }}; color: white; ring-color: {{ hero.cta_bg_color|default:'#3b82f6' }};"
                           {% if not hero.cta_link %}onclick="return false;"{% endif %}
                           onclick="trackHeroCTAClick(event)">
                            {{ hero.cta_text|default:'Learn More' }}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Rotating Text Animation
        const rotatingTextElement = document.querySelector('.rotating-text');
        if (rotatingTextElement) {
            const rotatingTexts = [
                {% for text_item in hero.rotating_texts.all %}
                "{{ text_item.text|escapejs }}"{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            
            if (rotatingTexts.length > 0) {
                let currentIndex = 0;
                
                function rotateText() {
                    rotatingTextElement.style.opacity = '0';
                    
                    setTimeout(() => {
                        rotatingTextElement.textContent = rotatingTexts[currentIndex];
                        rotatingTextElement.style.opacity = '1';
                        currentIndex = (currentIndex + 1) % rotatingTexts.length;
                    }, 300);
                }
                
                // Initial text
                rotateText();
                
                // Rotate text at specified interval
                setInterval(rotateText, {{ hero.rotating_text_settimeout|default:3000 }});
            }
        }
        
        // Background/Slide Image Slider Animation
        const backgroundImages = document.querySelectorAll('.hero-bg-image');
        const slideImages = document.querySelectorAll('.hero-slide-image');
        
        function startSlider(images) {
            if (images.length > 0) {
                let index = 0;
                images[0].style.opacity = '1';
                
                setInterval(() => {
                    if (images[index]) {
                        images[index].style.opacity = '0';
                    }
                    index = (index + 1) % images.length;
                    if (images[index]) {
                        images[index].style.opacity = '1';
                    }
                }, {{ hero.image_settimeout|default:5000 }});
            }
        }
        
        startSlider(backgroundImages);
        startSlider(slideImages);
        
        // Re-initialize Lucide icons after content is loaded
        if (typeof lucide !== 'undefined') {
            setTimeout(() => {
                lucide.createIcons();
            }, 100);
        }
    });
    
    // Track Hero CTA Click
    function trackHeroCTAClick(event) {
        event.preventDefault();
        const link = event.target.closest('a');
        const url = link ? link.href : '#';
        
        // Send AJAX request to track the click
        fetch(`/track/hero-cta-click/{{ hero.id }}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        }).then(response => {
            if (response.ok) {
                // Redirect to the original URL after tracking
                if (url !== '#') {
                    window.location.href = url;
                }
            }
        }).catch(error => {
            console.error('Error tracking click:', error);
            // Redirect anyway if tracking fails
            if (url !== '#') {
                window.location.href = url;
            }
        });
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
</section>
{% endif %}